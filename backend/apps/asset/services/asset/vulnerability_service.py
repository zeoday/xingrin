"""Vulnerability Service - 漏洞资产业务逻辑层"""

import logging
from typing import List

from apps.asset.models import Vulnerability
from apps.asset.dtos.asset import VulnerabilityDTO
from apps.common.decorators import auto_ensure_db_connection

logger = logging.getLogger(__name__)


@auto_ensure_db_connection
class VulnerabilityService:
    """漏洞资产服务

    当前提供基础的批量创建能力，使用 ignore_conflicts 依赖数据库唯一约束去重。
    """

    def bulk_create_ignore_conflicts(self, items: List[VulnerabilityDTO]) -> None:
        """批量创建漏洞资产记录，忽略冲突。

        Note:
            - 是否去重取决于模型上的唯一/部分唯一约束；
            - 当前 Vulnerability 模型未定义唯一约束，因此会保留全部记录。
        """
        if not items:
            logger.debug("漏洞资产列表为空，跳过保存")
            return

        try:
            vulns = [
                Vulnerability(
                    target_id=item.target_id,
                    url=item.url,
                    vuln_type=item.vuln_type,
                    severity=item.severity,
                    source=item.source,
                    cvss_score=item.cvss_score,
                    description=item.description,
                    raw_output=item.raw_output,
                )
                for item in items
            ]

            Vulnerability.objects.bulk_create(vulns, ignore_conflicts=True)
            logger.info("漏洞资产保存成功 - 数量: %d", len(vulns))

        except Exception as e:
            logger.error(
                "批量保存漏洞资产失败 - 数量: %d, 错误: %s",
                len(items),
                str(e),
                exc_info=True,
            )
            raise

    # ==================== 查询方法 ====================

    def get_all(self):
        """获取所有漏洞 QuerySet（用于全局漏洞列表）。

        Returns:
            QuerySet[Vulnerability]: 所有漏洞，按发现时间倒序
        """
        return Vulnerability.objects.all().order_by("-discovered_at")

    def get_vulnerabilities_by_target(self, target_id: int):
        """按目标获取漏洞 QuerySet（用于分页）。

        Args:
            target_id: 目标 ID

        Returns:
            QuerySet[Vulnerability]: 目标下的所有漏洞，按发现时间倒序
        """
        return Vulnerability.objects.filter(target_id=target_id).order_by("-discovered_at")

    def count_by_target(self, target_id: int) -> int:
        """统计目标下的漏洞数量。"""
        return Vulnerability.objects.filter(target_id=target_id).count()
